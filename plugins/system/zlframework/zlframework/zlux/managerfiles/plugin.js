/**
 * @package     ZOOlanders
 * @version     3.3.27
 * @author      ZOOlanders - http://zoolanders.com
 * @license     GNU General Public License v2 or later
 */

!function(e,a,t,o){"use strict";var l=function(){};e.extend(l.prototype,e.zlux.Manager.prototype,{name:"filesManager",options:{root:"images",extensions:"",storage:"local",storage_params:{},max_file_size:"",resize:{}},initialize:function(a,t){this.options=e.extend({},this.options,t);var o=this;o.initCheck(),o.target=a,o.filesmanager=e('<div class="zl-bootstrap zlux-filesmanager" />').appendTo(a),o.initDataTable(o.filesmanager)},initCheck:function(){var a=this;e.zlux.filesManager.iNextUnique++,a.ID=e.zlux.filesManager.iNextUnique,e.zlux.filesManager.instances[a.ID]=a,a.options.max_file_size=a.parseSize(a.options.max_file_size),a.options.extensions=a.options.extensions.replace(/\|/g,","),""!==a.options.storage&&void 0!==a.options.storage&&null!==a.options.storage||(a._ErrorLog(0,a._("STORAGE_PARAM_MISSING")),a.options.storage="local"),a.sStartRoot=a.cleanPath(a.options.root),a.sCurrentPath=a.sStartRoot},initDataTable:function(a){var t=this;e.zlux.assets.load(e.zlux.url.zlfw("zlux/assets/datatables/dataTables.with.plugins.min.js"),function(){t._initDataTable(a)})},_initDataTable:function(a){var t=this;e('<table cellpadding="0" cellspacing="0" border="0" class="table table-striped table-bordered" />').appendTo(a),t.oTable=e("table",a).dataTable({sDom:"F<'row-fluid'<'span12't>>",oLanguage:{sEmptyTable:t._("EMPTY_FOLDER"),sInfoEmpty:""},sAjaxUrl:e.zlux.url.ajax("zlux"),sAjaxSource:e.zlux.url.ajax("zlux","getManagerFilesData"),sServerMethod:"POST",bPaginate:!1,aoColumns:[{sTitle:"",mData:"type",bSearchable:!1,sWidth:"14px",sClass:"column-icon",mRender:function(e,a){return"display"===a?'<i class="icon-'+("folder"===e?"folder-close":"file-alt")+'"></i>':e}},{sTitle:t._("NAME"),mData:"name",sClass:"column-name",mRender:function(e,a){return"display"===a?"":e},fnCreatedCell:function(a,o,l){e(a).parent("tr").attr("data-id",t.cleanPath(l.name))}}],aoColumnDefs:{bVisible:!1,aTargets:[2]},aaSorting:[[0,"desc"],[1,"asc"]],fnServerData:function(e,a,o,l){t._fnServerData(e,a,o,l)},fnServerParams:function(e){e.push({name:"extensions",value:t.options.extensions}),"s3"===t.options.storage&&(e.push({name:"storage",value:"s3"}),e.push({name:"accesskey",value:t.options.storage_params.accesskey}),e.push({name:"key",value:t.options.storage_params.secretkey}),e.push({name:"bucket",value:t.options.storage_params.bucket}))},fnRowCallback:function(a,o){var l=o;l.dom=e(a),l.dom.attr("data-type",o.type).addClass("zlux-object"),e(".column-name",l.dom).html("").removeClass("zlux-ui-open").append(t.renderObjectDOM(l)),e(".zlux-x-name",l.dom).append('<i class="zlux-x-name-edit icon-edit-sign" title="'+t._("RENAME")+'" />')},fnInitComplete:function(){var o=e(".zlux-x-filter-input_wrapper",a).append(e('<i class="icon-search" />'),e('<i class="icon-remove zlux-ui-dropdown-unselect" />').hide().on("click",function(){e("input",o).val(""),e(this).hide(),t.oTable.fnFilter("")}));e("input",o).on("keyup",function(){""===e(this).val()?e(".zlux-ui-dropdown-unselect",o).hide():e(".zlux-ui-dropdown-unselect",o).show()}),setTimeout(function(){t.trigger("InitComplete")},50)},fnPreDrawCallback:function(){t.zluxdialog.spinner("show")},fnDrawCallback:function(a){var o=a.oInstance.fnPagingInfo(),l=e(".dataTables_paginate",e(a.nTableWrapper)).closest(".row-fluid");o.iTotalPages<=1?l.hide():l.show(),t.trigger("DrawCallback"),t.zluxdialog.scrollbar("refresh"),t.zluxdialog.spinner("hide")}}).on("click",".zlux-object .zlux-x-name a",function(){var a=e(this).closest("tr.zlux-object"),o=t.oTable.fnGetData(a[0]);return o.dom=a,"true"!==o.dom.attr("data-zlux-object-status")&&(o.dom.attr("data-zlux-object-status","true"),o.dom.siblings().removeAttr("data-zlux-object-status"),t.trigger("ObjectSelected",o),"folder"===o.dom.data("type")&&(t.oTable.fnSettings(),t.sGoToPath=o.dom.data("id"),t.oTable.fnReloadAjax())),!1}).on("click",".zlux-object .zlux-x-remove",function(){var a=e(this).closest("tr.zlux-object"),o=e("td",a),l=t.oTable.fnGetData(a[0]);return l.dom=a,o.hasClass("zlux-ui-open")&&t.trigger("BeforeDeleteFile",l),!1})},_fnServerData:function(a,t,o,l){var n,i=this;n=i.cleanPath(i.sCurrentPath+"/"+i.sGoToPath),i.sGoToPath="",t.push({name:"root",value:n}),l.jqXHR=e.ajax({url:a,data:t,beforeSend:function(){var a=!1;if(!i.bReloading||i.bRedrawing){var t=e.zlux.filesManager.aAjaxDataCache[n];if(t&&(i.bCacheInited||(i.sStartRoot=t.root),i.sCurrentPath=n,i.bCacheInited=!0,e(l.oInstance).trigger("xhr",[l,t]),o(t),a=!0),i.bRedrawing)return i.bRedrawing=!1,i.sCurrentPath=n,!1}if(a)return!1;i.zluxdialog.spinner("show")},dataType:"json",cache:!1,type:l.sServerMethod,error:function(e,a){"parsererror"===a&&l.oApi._fnLog(l,0,"DataTables warning: JSON data from server could not be parsed. This is caused by a JSON formatting error.")}}).done(function(a){a.errors.length&&l.oApi._fnLog(l,0,a.errors),a=a.result,i.bCacheInited||(i.sStartRoot=a.root),i.sCurrentPath=a.root,i.bReloading&&(e.zlux.filesManager.aAjaxDataCache={}),e.zlux.filesManager.aAjaxDataCache[a.root]=a,i.redrawInstances(),i.bReloading=!1,i.bCacheInited=!0,e(l.oInstance).trigger("xhr",[l,a]),o(a)})},reload:function(){var e=this;e.bReloading=!0,e.oTable.fnReloadAjax()},redrawInstances:function(){var a=this;e.each(e.zlux.filesManager.instances,function(e,t){if(parseInt(e)===a.ID)return!0;t.oTable&&(t.bRedrawing=!0,t.oTable.fnReloadAjax())})},initBreadcrumb:function(){var a=this;a.breadcrumb=e('<ul class="breadcrumb" />').prependTo(a.filesmanager).wrap('<div class="row-fluid"><div class="span12" /></div>').on("click","a",function(){return a.sCurrentPath=a.sStartRoot,a.sGoToPath=e(this).data("path"),a.oTable.fnReloadAjax(),!1}),a.bind("DrawCallback initBreadcrumb",function(){var t,o=a.sCurrentPath?a.sCurrentPath:"",l=[],n=a._("ROOT").toLowerCase();o=o.replace(new RegExp("^"+a.sStartRoot),""),o=o.replace(/(^\/|\/$)/,""),t=o.length?o.split("/"):[],t.length?l.push('<li><a href="#" data-path="">'+n+'</a><span class="divider">/</span></li>'):l.push('<li class="active">'+n+"</li>"),o=[],e.each(t,function(e,a){o.push(a),t.length===e+1?l.push('<li class="active">'+a.toLowerCase()+"</li>"):l.push('<li><a href="#" data-path="'+o.join("/")+'">'+a.toLowerCase()+'</a><span class="divider">/</span></li>')}),a.breadcrumb.html(l.join(""))}).trigger("initBreadcrumb")},renderObjectDOM:function(a){var t,o=this;t="folder"===a.type?[{name:o._("NAME"),value:a.basename}]:[{name:o._("NAME"),value:a.basename},{name:o._("TYPE"),value:a.content_type},{name:o._("SIZE"),value:a.size.display}];var l="";return e.each(t,function(e,a){l+="<li><strong>"+a.name+"</strong>: <span>"+a.value+"</span></li>"}),e('<div class="zlux-x-tools"><i class="zlux-x-details-btn icon-angle-down" /><i class="zlux-x-remove icon-minus-sign" title="'+o._("DELETE")+'" /></div><div class="zlux-x-name"><a href="#" class="zlux-x-name-link">'+a.name+'</a></div><div class="zlux-x-details"><div class="zlux-x-messages" /><div class="zlux-x-details-content"><ul class="unstyled">'+l+"</ul></div></div>")},deleteObject:function(a){var t=this,o=[],l=t.getFullPath(a.name);return o=t.pushStorageData(o),"s3"===t.options.storage&&"folder"===a.type&&(l+="/"),o.push({name:"path",value:l}),e.Deferred(function(a){e.ajax({url:e.zlux.url.ajax("zlux","deleteObject"),data:o,dataType:"json",type:"post"}).done(function(e){e.result?(a.resolve(),t.trigger("FileDeleted",l)):a.reject(e.errors)}).fail(function(){a.reject(t._("SOMETHING_WENT_WRONG"))})}).promise()},createFolder:function(a){var t=this,o=[],l=t.getFullPath(a);return o=t.pushStorageData(o),"s3"===t.options.storage&&(l+="/"),o.push({name:"path",value:l}),e.Deferred(function(a){e.ajax({url:e.zlux.url.ajax("zlux","newFolder"),data:o,dataType:"json",type:"post"}).done(function(e){e.result?a.resolve(e.name):a.reject(e.errors)}).fail(function(){a.reject(t._("SOMETHING_WENT_WRONG"))})}).promise()},renameObject:function(a){var t=this,o=e(".zlux-x-name a",a.dom),l=o.html().match(/\.+[a-zA-Z]+$/g),n=o.html().replace(/\.+[a-zA-Z]+$/g,"");l=null!==l?l:"";var i=e("<div>"+t._("INPUT_THE_NEW_NAME")+'<br /><input class="zlux-x-input" type="text" value="'+n+'" /> '+l+'<br /><span class="label label-success label-link">'+t._("CONFIRM").toLowerCase()+"</span></div>").on("click",".label-link",function(){e(this).data("submited")||(e(this).data("submited",!0),e(".column-icon i",a.dom).addClass("icon-spinner icon-spin"),t._changeObjectName(a,e("input",i).val()+l).done(function(l){o.html(l),e(".zlux-x-details-content ul li:first span",a.dom).html(l),a.dom.attr("data-id",l),a.name=l,a.basename=l.replace(/\.+[a-zA-Z]+$/g,""),void 0!==a.path&&(a.path=a.path.replace(/(\w|[-.])+$/,l)),e.zlux.filesManager.aAjaxDataCache[t.sCurrentPath].aaData=t.oTable.fnGetData(),t.redrawInstances(),a.dom.removeAttr("data-zlux-object-status"),e(".zlux-x-msg",a.dom).remove()}).fail(function(e){t.pushMessageToObject(a,e)}).always(function(){e(".column-icon i",a.dom).removeClass("icon-spinner icon-spin")}))}).on("keypress","input",function(a){13===(a.keyCode?a.keyCode:a.which)&&e(".label-link",i).trigger("click")});t.pushMessageToObject(a,i)},_changeObjectName:function(a,t){var o=this,l=[],n=o.getFullPath(a.name),i=o.getFullPath(t);return l=o.pushStorageData(l),"s3"===o.options.storage&&"folder"===a.type&&(n+="/",i+="/"),l.push({name:"src",value:n}),l.push({name:"dest",value:i}),e.Deferred(function(a){e.ajax({url:e.zlux.url.ajax("zlux","moveObject"),data:l,dataType:"json",type:"post"}).done(function(e){e.result?a.resolve(e.name):a.reject(e.errors)}).fail(function(){a.reject(o._("SOMETHING_WENT_WRONG"))})}).promise()},getFullPath:function(e){var a=this.sCurrentPath;return a?a+"/"+e:e},_getRowFromPath:function(a){return e('tr[data-path="'+a+'"]',this.oTable)},parseSize:function(e){if("string"!=typeof e||""===e)return e;var a,t={t:1099511627776,g:1073741824,m:1048576,k:1024};return e=/^([0-9]+)([mgk]?)$/.exec(e.toLowerCase().replace(/[^0-9mkg]/g,"")),a=e[2],e=+e[1],t.hasOwnProperty(a)&&(e*=t[a]),e},pushStorageData:function(e){var a=this;return"s3"===a.options.storage&&(e.push({name:"storage",value:"s3"}),e.push({name:"accesskey",value:a.options.storage_params.accesskey}),e.push({name:"key",value:a.options.storage_params.secretkey}),e.push({name:"bucket",value:a.options.storage_params.bucket})),e}}),e.zlux[l.prototype.name]=l,e.zlux[l.prototype.name].iNextUnique=0,e.zlux[l.prototype.name].aAjaxDataCache={},e.zlux[l.prototype.name].instances={}}(jQuery,window,document),function(e,a,t,o){"use strict";var l=function(a,t){var o=this;e(a).data(l.prototype.name)||(o.element=e(a),o.options=e.extend({},l.prototype.options,e.zlux.filesManager.prototype.options,t),this.events={},o.initialize(),o.element.data(l.prototype.name,o))};e.extend(l.prototype,e.zlux.filesManager.prototype,{name:"filesDialogManager",options:{title:"Files Manager",full_mode:0,dialogClass:""},initialize:function(){var e=this;e.initCheck(),e.element.on("click",function(){return e.zluxdialog.toggle(),!1}),e.initDialog(),e.initMainEvents()},initDialog:function(){var a=this;a.options.dialogClass="zl-bootstrap zlux-filesmanager"+(a.options.full_mode?" zlux-dialog-full ":"")+(a.options.dialogClass?" "+a.options.dialogClass:""),e.zlux.assets.load("dialog").done(function(){a.zluxdialog=e.zlux.dialog({title:a.options.title,width:a.options.full_mode?"75%":300,dialogClass:a.options.dialogClass,position:!1===a.options.full_mode?{of:a.element,my:"left top",at:"right bottom"}:null}).bind("InitComplete",function(){a.zluxdialog.widget.attr("id","zluxFilesManager_"+a.ID),a.eventDialogLoaded()})})},eventDialogLoaded:function(){var a=this;a.filesmanager=e('<div class="zlux-filesmanager" />').appendTo(a.zluxdialog.content),a.initDataTable(a.filesmanager),a.zluxdialog.main.on("click",".zlux-x-details-btn",function(){var t=e(this),o=t.closest("tr.zlux-object"),l=e("td.column-name",o),n=e(".zlux-x-details",o);l.hasClass("zlux-ui-open")?(t.addClass("icon-angle-down").removeClass("icon-angle-up"),l.removeClass("zlux-ui-open"),n.slideUp("fast",function(){a.zluxdialog.scrollbar("refresh")})):(l.addClass("zlux-ui-open"),t.removeClass("icon-angle-down").addClass("icon-angle-up"),a.zluxdialog.content.stop().animate({scrollTop:o.get(0).offsetTop},900,"swing"),n.slideDown("fast",function(){a.zluxdialog.scrollbar("refresh")}))}),a.zluxdialog.main.on("click",".icon-edit-sign",function(){var t,o=e(this).closest("tr.zlux-object");t=a.oTable.fnGetData(o[0]),t.dom=o,a.renameObject(t)}),e("html").on("mousedown",function(e){!a.zluxdialog.dialog("isOpen")||a.element.is(e.target)||a.element.find(e.target).length||a.zluxdialog.widget.find(e.target).length||a.zluxdialog.dialog("close")}),a.initMainToolbar(),a.zluxdialog.newSubToolbar("filter","main"),a.zluxdialog.newSubToolbar("newfolder","main"),a.initUploader()},initMainEvents:function(){var a=this;a.bind("InitComplete",function(){a.zluxdialog.scrollbar("refresh");var t=e(".zlux-dialog-subtoolbar-filter",a.zluxdialog.toolbar.wrapper);e(".zlux-x-filter-input_wrapper",a.oTable.fnSettings().nTableWrapper).appendTo(t),a.initBreadcrumb(),a.zluxdialog.initContent()}).bind("BeforeDeleteFile",function(t,o){if(!e(".zlux-x-details-message-actions")[0]){var l="folder"===o.type?"DELETE_THIS_FOLDER":"DELETE_THIS_FILE",n=e("<div>"+a._(l)+'<span class="label label-warning label-link">'+a._("CONFIRM").toLowerCase()+"</span></div>").on("click",".label-link",function(){if(!e(this).data("submited")){e(this).data("submited",!0),e(".column-icon i",o.dom).addClass("icon-spinner icon-spin");a.deleteObject(o).done(function(){o.dom.fadeOut("slow",function(){e(this).remove();var t=e.zlux.filesManager.aAjaxDataCache[a.sCurrentPath].aaData;e.each(t,function(e,a){if(o.dom.data("id")===a.name&&o.dom.data("type")===a.type)return t.splice(e,1),!1}),a.redrawInstances()})}).fail(function(e){a.pushMessageToObject(o,e)}).always(function(){e(".column-icon i",o.dom).removeClass("icon-spinner icon-spin")})}});a.pushMessageToObject(o,n)}})},initMainToolbar:function(){var a=this;a.zluxdialog.setMainToolbar([{title:a._("APPLY_FILTERS"),icon:"filter",click:function(e){a.zluxdialog.toggleSubtoolbar("filter","main"),e.parent().siblings().children("i").not(e).removeClass("zlux-ui-tool-enabled"),e.toggleClass("zlux-ui-tool-enabled")}},{title:a._("NEW_FOLDER"),icon:"folder-close",subicon:"plus-sign",click:function(t){a.zluxdialog.toggleSubtoolbar("newfolder","main"),e(".zlux-dialog-subtoolbar-newfolder",a.zluxdialog.toolbar.wrapper).html("").append(e('<input type="text" class="zlux-x-input" placeholder="'+a._("FOLDER_NAME")+'" />').on("keypress",function(t){13===(t.keyCode?t.keyCode:t.which)&&(a.createFolder(e(this).val()),a.zluxdialog.spinner("show"),a.createFolder(e(this).val()).always(function(){a.reload()}))})),t.parent().siblings().children("i").not(t).removeClass("zlux-ui-tool-enabled"),t.toggleClass("zlux-ui-tool-enabled")}},{title:a._("UPLOAD_FILES"),icon:"cloud-upload",click:function(){a.zluxdialog.showToolbar(2),a.zluxdialog.scrollbar("hide"),e(".zlux-filesmanager",a.zluxdialog.content).fadeOut("400",function(){a.zluxupload.inited||a.zluxupload.init(),a.zluxupload.options.path=a.sCurrentPath,e(".zlux-upload",a.zluxdialog.content).fadeIn("400")})}},{title:a._("REFRESH"),icon:"refresh",click:function(){a.reload()}}])},initUploader:function(){var a=this;a.zluxdialog.newToolbar([{title:a._("ADD_NEW_FILES"),icon:"plus-sign",id:"add",click:function(){}},{title:a._("START_UPLOADING"),icon:"upload disabled",id:"start",click:function(){return a.zluxupload.uploader.start(),!1}},{title:a._("CANCEL_CURRENT_UPLOAD"),icon:"ban-circle disabled",id:"cancel",click:function(){a.zluxupload.uploader.stop(),a.zluxdialog.toolbarBtnState(2,"ban-circle","disabled"),a.zluxdialog.toolbarBtnState(2,"upload","enabled"),a.zluxdialog.toolbarBtnState(2,"plus-sign","enabled")}}],2,function(){e(".zlux-upload",a.zluxdialog.content).fadeOut("400",function(){a.zluxupload.emptyQueue(),e(".zlux-filesmanager",a.zluxdialog.content).fadeIn("400"),a.zluxupload._updateFilelist(),a.zluxdialog.scrollbar("refresh")})}),a.zluxupload=e.zlux.filesUpload({path:"images",wrapper:a.zluxdialog.content,storage:a.options.storage,storage_params:a.options.storage_params,max_file_size:a.options.max_file_size,extensions:a.options.extensions,browse_button:e('.zlux-dialog-toolbar-2 i[data-id="add"]',a.zluxdialog.toolbar.wrapper),resize:a.options.resize}).bind("QueueChanged",function(){a.zluxdialog.scrollbar("refresh")}).bind("FilesAdded",function(t,o){a.zluxdialog.toolbarBtnState(2,"upload","enabled"),t.filelist.show(),e.each(o,function(o,l){l.status="validating";var n={name:l.name,basename:l.name.replace(/(\.[a-z0-9]+)$/,""),type:"file",content_type:l.type,size:{size:l.size,display:plupload.formatSize(l.size)}};if(n.dom=e('<tr id="'+l.id+'" class="zlux-object" data-zlux-status="validating" />').append(e('<td class="column-icon" />').append('<i class="icon-file-alt zlux-x-object-icon" />'),e('<td class="column-name" />').append(a.renderObjectDOM(n))).appendTo(t.filelist),e(".zlux-x-tools",n.dom).append(e('<span class="zlux-upload-file-progress"/>')),e(".zlux-x-name",n.dom).html(l.name),void 0!==l.size&&""!==a.options.max_file_size&&l.size>a.options.max_file_size){e(".icon-file-alt",n.dom).removeClass("icon-file-alt").addClass("icon-warning-sign");var i=a.pushMessageToObject(n,a.sprintf(a._("FILE_SIZE_ERROR"),plupload.formatSize(a.options.max_file_size)));return e(".zlux-x-msg-remove",i).remove(),!0}e.ajax({url:e.zlux.url.ajax("zlux","validateObjectName"),type:"post",data:{name:l.name},dataType:"json",cache:!1,beforeSend:function(){e(".column-icon i",n.dom).addClass("icon-spinner icon-spin")},success:function(a){e(".zlux-x-name",n.dom).html(a.result),l.name=a.result,l.status=1,t._handleFileStatus(l),e(".column-icon i",n.dom).removeClass("icon-spinner icon-spin"),t._updateFilelist()}})})}).bind("BeforeUpload",function(){a.zluxdialog.toolbarBtnState(2,"cancel","enabled"),a.zluxdialog.toolbarBtnState(2,"start","disabled"),a.zluxdialog.toolbarBtnState(2,"add","disabled")}).bind("FileUploaded",function(t,o){e(".zlux-x-name",o.dom).html(o.name),e(".zlux-upload-file-progress",o.dom).html("100%").fadeOut(),e(".zlux-x-object-icon",o.dom).removeClass("icon-file-alt").addClass("icon-ok"),e(".zlux-x-name",o.dom).wrapInner('<a class="zlux-x-name-link" href="#" />').end().on("click","a",function(){if(a.zluxdialog.spinning)return!1;var t=e('.zlux-object[data-id="'+o.name+'"]',a.filesmanager);return o=a.oTable.fnGetData(t[0]),a.trigger("ObjectSelected",o),!1})}).bind("FileNotUpload",function(t,o,l){a.zluxdialog.toolbarBtnState(2,"cancel","disabled"),a.zluxdialog.toolbarBtnState(2,"start","disabled"),a.zluxdialog.toolbarBtnState(2,"add","enabled"),e(".zlux-upload-file-progress",o.dom).fadeOut(),e(".zlux-x-object-icon",o.dom).removeClass("icon-file-alt").addClass("icon-warning-sign");var n=a.pushMessageToObject(o,l);e(".zlux-x-msg-remove",n).remove()}).bind("UploadComplete",function(){a.zluxdialog.toolbarBtnState(2,"cancel","disabled"),a.zluxdialog.toolbarBtnState(2,"start","disabled"),a.zluxdialog.toolbarBtnState(2,"add","enabled"),a.reload()}).bind("CancelUpload",function(){a.zluxdialog.toolbarBtnState(2,"cancel","disabled"),a.zluxdialog.toolbarBtnState(2,"add","enabled")}).bind("QueueChanged",function(t,o){var l=!1;e.each(o,function(e,a){a.status!==plupload.DONE&&"validating"!==a.status&&(l=!0)}),o.length&&l?a.zluxdialog.toolbarBtnState(2,"start","enabled"):a.zluxdialog.toolbarBtnState(2,"start","disabled")}).bind("FileError",function(t,o,l){if(a.uploading&&"pending"===a.uploading.state())return void a.uploading.reject(l);o.dom[0]||(o.dom=e('<tr id="'+o.id+'" class="zlux-object" />').append(e('<td class="column-icon" />').append('<i class="icon-file-alt zlux-x-object-icon" />'),e('<td class="column-name" />').append(a.renderObjectDOM(o))).appendTo(t.filelist),t._updateFilelist()),e(".zlux-x-object-icon",o.dom).removeClass("icon-file-alt").addClass("icon-warning-sign");var n=a.pushMessageToObject(o,l);e(".zlux-x-msg-remove",n).remove()})}}),e.zlux[l.prototype.name]=l}(jQuery,window,document),function(e,a,t,o){"use strict";var l=function(a){this.options=e.extend({},this.options,a),this.events={}};e.extend(l.prototype,e.zlux.Main.prototype,{name:"filesUpload",options:{extensions:"",path:null,fileMode:"files",max_file_size:"1024kb",wrapper:null,storage:"local",storage_params:{},browse_button:null,resize:{}},init:function(){var a=this;a.upload=e('<div class="zlux-upload" />').attr("data-zlux-status","").appendTo(a.options.wrapper).hide(),a.dropzone=e('<div class="zlux-upload-dropzone" />').appendTo(a.upload).append(e('<span class="zlux-upload-dropzone-msg" />')),a.initDnDevents(),a.bind("WindowDragHoverStart",function(){a.dropzone.attr("data-zlux-draghover",!0)}),a.bind("WindowDragHoverEnd",function(){a.dropzone.attr("data-zlux-draghover",!1)}),a.initFilelist(),e.zlux.assets.load(e.zlux.url.zlfw("zlux/assets/plupload/plupload.full.min.js"),function(){a.initPlupload(),a.bind("Init",function(){"html5"===a.uploader.runtime&&e(".zlux-upload-dropzone-msg",a.dropzone).html(a.sprintf(a._("DROP_FILES"),"zlux-upload-browse")).on("click","a",function(){return a.options.browse_button.trigger("click"),!1}),a.inited=!0})})},initFilelist:function(){var a=this;a.filelist=e('<table cellpadding="0" cellspacing="0" border="0" class="zlux-upload-filelist table table-striped table-bordered"><tbody /></table>').appendTo(a.upload).on("click",".zlux-x-remove",function(){if("uploding"!==e(this).closest(".zlux-object").data("zlux-status")){var t=e(this).closest(".zlux-object"),o=a.uploader.getFile(t[0].id);o&&("undefined"===o||o.zlux_status!==plupload.STARTED&&o.status!==plupload.UPLOADING)?(a.uploader.removeFile(o),t.remove()):(t.remove(),a._updateFilelist())}})},initPlupload:function(){var a=this,t={runtimes:"html5, flash",browse_button:a.options.browse_button[0],drop_element:a.dropzone[0],max_file_size:void 0,url:e.zlux.url.ajax("zlux","upload",a.options.resize),filters:[{title:"Files",extensions:a.options.extensions}],flash_swf_url:e.zlux.url.zlfw("zlux/assets/plupload/Moxie.swf")};"s3"===a.options.storage&&e.extend(t,{url:"https://"+a.options.storage_params.bucket+".s3.amazonaws.com",multipart:!0,multipart_params:{key:"${filename}",Filename:"${filename}",acl:"public-read",success_action_status:"201",AWSAccessKeyId:a.options.storage_params.accesskey,policy:a.options.storage_params.policy,signature:a.options.storage_params.signature},file_data_name:"file"}),e.extend(t,{init:{BeforeUpload:function(e,t){a.eventBeforeUpload(t)},UploadFile:function(e,t){a.eventUploadFile(t)},UploadProgress:function(e,t){a.eventUploadProgress(t)},FileUploaded:function(e,t,o){a.eventFileUploaded(t,o)},UploadComplete:function(e,t){a.eventUploadComplete(t)},CancelUpload:function(){a.eventCancelUpload()},FilesAdded:function(e,t){a.eventFilesAdded(t)},QueueChanged:function(){a.eventQueueChanged()},StateChanged:function(){a.eventStateChanged()},Error:function(e,t){a.eventError(t)}}}),a.uploader=new plupload.Uploader(t),a.uploader.bind("Init",function(){a.trigger("Init")}),a.uploader.init()},eventError:function(a){var t,o,l=this,n=a.file;if(n){if(t="<strong>"+a.message+"</strong>",o=a.details)t+=" <br /><i>"+a.details+"</i>";else{switch(a.code){case plupload.FILE_EXTENSION_ERROR:o=l._("FILE_EXT_ERROR").replace("%s",n.name);break;case plupload.IMAGE_MEMORY_ERROR:o=l._("RUNTIME_MEMORY_ERROR");break;case plupload.HTTP_ERROR:o="s3"===l.options.storage?l.options.storage_params.bucket.match(/\./g)?l._("S3_BUCKET_PERIOD_ERROR"):l._("S3_BUCKET_MISSCONFIG_ERROR"):l._("UPLOAD_URL_ERROR")}t+=" <br /><i>"+o+"</i>"}var i={name:n.name,basename:n.name.replace(/(\.[a-z0-9]+)$/,""),type:"file",content_type:n.type,size:{size:n.size,display:plupload.formatSize(n.size)}};i.dom=e("#"+n.id,l.filelist),l.trigger("FileError",i,t)}},eventStateChanged:function(){var e=this;e.uploader.state===plupload.UPLOADING&&e.upload.attr("data-zlux-status","uploading"),e.uploader.state===plupload.STOPPED&&(e.upload.attr("data-zlux-status","stopped"),e._updateFilelist())},eventBeforeUpload:function(a){var t=this,o=e("#"+a.id,t.filelist);if("local"===t.options.storage&&(t.uploader.settings.url=t.uploader.settings.url+"&path="+t.options.path),"s3"===t.options.storage){var l=t.options.path?t.options.path+"/":"";t.uploader.settings.multipart_params.key=l+a.name}e(".zlux-upload-file-progress",o).html("0%"),a.zlux_status=2,t._handleFileStatus(a),e(".zlux-upload-file-btn-remove",o).removeClass("icon-remove").addClass("icon-spinner icon-spin"),t.trigger("BeforeUpload",a)},eventUploadFile:function(a){var t=this,o={name:a.name,basename:a.name.replace(/(\.[a-z0-9]+)$/,""),type:"file",content_type:a.type,size:{size:a.size,display:plupload.formatSize(a.size)}};o.dom=e("#"+a.id,t.filelist),t.uploading=e.Deferred().fail(function(e){t.trigger("FileNotUpload",o,e)}).done(function(e){o.name=e,t.trigger("FileUploaded",o)}).always(function(){t._handleFileStatus(a)})},eventUploadProgress:function(a){var t=this,o=isNaN(a.percent)?0:a.percent;e("#"+a.id+" .zlux-upload-file-progress",t.filelist).html(o+"%"),t._handleFileStatus(a)},eventFileUploaded:function(a,t){var o,l=this;"local"===l.options.storage?(o=e.parseJSON(t.response),o.error?l.uploading.reject(o.error.message):l.uploading.resolve(o.result)):"s3"===l.options.storage&&(o=e(t.response),l.uploading.resolve(o.find("Key").html()))},eventUploadComplete:function(e){this.trigger("UploadComplete",e)},eventCancelUpload:function(){this.trigger("CancelUpload")},eventFilesAdded:function(e){this.trigger("FilesAdded",e)},eventQueueChanged:function(){this._updateFilelist()},getQueuedFiles:function(){var a=this,t=[];return e.each(a.uploader.files,function(e,a){a.status!==plupload.DONE&&"validating"!==a.status&&t.push(a)}),t},emptyQueue:function(){var e=this;e.uploader.splice(),e.filelist.empty()},_updateFilelist:function(){var a=this,t=!1,o=e(".zlux-object",a.filelist);e.each(a.uploader.files,function(e,o){o.status!==plupload.DONE&&"validating"!==o.status&&(t=!0),o.status===plupload.STOPPED&&a._handleFileStatus(o)}),(a.uploader.files.length||o.length)&&e(".zlux-upload-dropzone-msg",a.upload).hide(),a.uploader.files.length||o.length?t?a.upload.attr("data-zlux-status","queued"):a.upload.attr("data-zlux-status","stopped"):(a.upload.attr("data-zlux-status",""),e(".zlux-upload-dropzone-msg",a.upload).fadeIn()),a.trigger("QueueChanged",a.uploader.files)},_handleFileStatus:function(a){var t=this,o=e("#"+a.id,t.filelist),l="";a.zlux_status===plupload.STARTED?(l="started",a.zlux_status=""):(a.status===plupload.DONE&&(l="done"),a.status===plupload.FAILED&&(l="failed"),a.status===plupload.QUEUED&&(l="queued"),a.status===plupload.UPLOADING&&(l="uploading"),a.status===plupload.STOPPED&&e(".zlux-upload-file-progress",o).html("")),o.attr("data-zlux-status",l)},initDnDevents:function(){var t=this,o=e(),l=e(),n=!1,i=!1;e(a).on("drop",function(e){return e.preventDefault(),!1}).on("dragenter",function(e){0===o.size()&&(t.trigger("WindowDragHoverStart"),n=!0,i=!1),o=o.add(e.target)}).on("dragleave drop",function(a){setTimeout(function(){var t=!1;try{t=!!e("body").find(a.relatedTarget).length||t}catch(e){}o=o.not(a.target),0!==o.size()||t||(n=!1)},1),setTimeout(function(){n||i||(t.trigger("WindowDragHoverEnd"),l=e(),o=e())},2)}),t.dropzone.on("dragenter",function(e){0===l.size()&&(t.trigger("WindowDragHoverStart"),n=!1,i=!0),l=l.add(e.target)}),t.dropzone.on("dragleave drop",function(a){setTimeout(function(){var t=!1;try{t=!!e("body").find(a.relatedTarget).length||t}catch(e){}l=l.not(a.target),0!==l.size()||t||(i=!1)},1),setTimeout(function(){n||i||(t.trigger("WindowDragHoverEnd"),l=e(),o=e())},2)})}}),e.zlux[l.prototype.name]=function(){var e=arguments;return new l(e[0]?e[0]:{})}}(jQuery,window,document),function(e,a,t,o){"use strict";var l=function(a){this.options=e.extend({},this.options,a),this.events={}};e.extend(l.prototype,e.zlux.Main.prototype,{name:"filesPreview",renderPreviewDOM:function(a,t){var o,l=[];t=void 0!==t&&t,a.size=void 0!==a.size&&a.size,l.push({name:"name",value:a.basename}),"folder"===a.type?o='<span class="zlux-x-folder"></span>':(o=t?'<div class="zlux-x-image"><img src="'+e.zlux.url.root(a.path)+'" /></div>':'<span class="zlux-x-filetype">'+a.ext+"</span>",a.size&&l.push({name:"size",value:a.size.display}));var n="";return e.each(l,function(e,a){n+="<li>"+a.value+"</li>"}),e('<div class="zlux-preview"><div class="zlux-x-thumbnail">'+o+'</div><ul class="zlux-x-details unstyled">'+n+"</ul></div>")}}),e.zlux[l.prototype.name]=function(){var e=arguments;return new l(e[0]?e[0]:{})}}(jQuery,window,document);